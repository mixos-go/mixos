name: MixOS-GO Build

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  GO_VERSION: '1.21'
  KERNEL_VERSION: '6.6.8'

jobs:
  test-mix-cli:
    name: Test Mix CLI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run tests
        working-directory: src/mix-cli
        run: |
          go mod tidy
          go test -v ./...

      - name: Build mix binary
        working-directory: src/mix-cli
        run: |
          CGO_ENABLED=1 go build -ldflags="-s -w" -o mix .
          ./mix --version

  build-kernel:
    name: Build Kernel
    runs-on: ubuntu-latest
    needs: test-mix-cli
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            bc \
            bison \
            flex \
            libelf-dev \
            libssl-dev \
            libncurses-dev

      - name: Cache kernel source
        uses: actions/cache@v4
        with:
          path: /tmp/mixos-build/linux-${{ env.KERNEL_VERSION }}
          key: kernel-${{ env.KERNEL_VERSION }}

      - name: Build kernel
        run: |
          export BUILD_DIR=/tmp/mixos-build
          export OUTPUT_DIR=${{ github.workspace }}/artifacts
          mkdir -p $OUTPUT_DIR
          bash build/scripts/build-kernel.sh
        timeout-minutes: 60

      - name: Upload kernel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel
          path: |
            artifacts/vmlinuz-mixos
            artifacts/modules-mixos.tar.gz

  build-iso:
    name: Build ISO
    runs-on: ubuntu-latest
    needs: build-kernel
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            grub-pc-bin \
            grub-efi-amd64-bin \
            xorriso \
            squashfs-tools \
            mtools \
            cpio

      - name: Download kernel artifacts
        uses: actions/download-artifact@v4
        with:
          name: kernel
          path: artifacts/

      - name: Build mix CLI
        working-directory: src/mix-cli
        run: |
          go mod tidy
          CGO_ENABLED=1 go build -ldflags="-s -w" -o ../../artifacts/mix .

      - name: Build packages
        run: |
          mkdir -p artifacts/packages
          for pkg in src/packages/*/build.sh; do
            if [ -f "$pkg" ]; then
              bash "$pkg" || true
            fi
          done

      - name: Build rootfs
        run: |
          export BUILD_DIR=/tmp/mixos-build
          export OUTPUT_DIR=${{ github.workspace }}/artifacts
          bash build/scripts/build-rootfs.sh

      - name: Build ISO
        run: |
          export BUILD_DIR=/tmp/mixos-build
          export OUTPUT_DIR=${{ github.workspace }}/artifacts
          bash build/scripts/build-iso.sh

      - name: Generate checksums
        run: |
          cd artifacts
          for f in *.iso *.tar.gz; do
            [ -f "$f" ] && sha256sum "$f" > "$f.sha256"
          done

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: mixos-iso
          path: |
            artifacts/*.iso
            artifacts/*.sha256

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build-iso
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: mixos-iso
          path: artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/*.iso
            artifacts/*.sha256
          draft: true
          generate_release_notes: true
