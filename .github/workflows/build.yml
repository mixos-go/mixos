name: MixOS-GO Build

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - viso-only

env:
  GO_VERSION: '1.21'
  KERNEL_VERSION: '6.6.8'
  VERSION: '1.0.0'

jobs:
  # ============================================================================
  # Test Mix CLI
  # ============================================================================
  test-mix-cli:
    name: Test Mix CLI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ${{ github.workspace }}/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Run vet and tests
        working-directory: src/mix-cli
        run: |
          go mod tidy
          go vet ./...
          go test -v ./...

      - name: Build mix binary
        working-directory: src/mix-cli
        run: |
          CGO_ENABLED=1 go build -ldflags="-s -w -X main.Version=${{ env.VERSION }}" -o mix .
          ./mix --version

      - name: Upload mix-cli
        uses: actions/upload-artifact@v4
        with:
          name: mix-cli
          path: src/mix-cli/mix

  # ============================================================================
  # Build Kernel (with mixmagisk support)
  # ============================================================================
  build-kernel:
    name: Build Kernel
    runs-on: ubuntu-latest
    needs: test-mix-cli
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            bc \
            bison \
            flex \
            libelf-dev \
            libssl-dev \
            libncurses-dev

      - name: Cache kernel source
        uses: actions/cache@v4
        with:
          path: /tmp/mixos-build/linux-${{ env.KERNEL_VERSION }}
          key: kernel-${{ env.KERNEL_VERSION }}-mixmagisk

      - name: Build kernel
        run: |
          export BUILD_DIR=/tmp/mixos-build
          export OUTPUT_DIR=${{ github.workspace }}/artifacts
          mkdir -p $OUTPUT_DIR/boot
          bash build/scripts/build-kernel.sh
        timeout-minutes: 60

      - name: Upload kernel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel
          path: |
            artifacts/boot/vmlinuz-mixos
            artifacts/vmlinuz-mixos
            artifacts/modules-mixos.tar.gz

  # ============================================================================
  # Build Rootfs
  # ============================================================================
  build-rootfs:
    name: Build Root Filesystem
    runs-on: ubuntu-latest
    needs: [test-mix-cli, build-kernel]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            squashfs-tools \
            cpio \
            gzip \
            xz-utils

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ${{ github.workspace }}/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download kernel artifacts
        uses: actions/download-artifact@v4
        with:
          name: mix-cli
          path: artifacts/

      - name: Build mix CLI
        working-directory: src/mix-cli
        run: |
          go mod tidy
          CGO_ENABLED=1 go build -ldflags="-s -w" -o ../../artifacts/mix .

      - name: Build installer binary
        working-directory: src/installer
        run: |
          mkdir -p ../../artifacts
          go mod tidy
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o ../../artifacts/mixos-install .
          ls -lah ../../artifacts || true

      - name: Smoke check installer
        run: |
          if [ -f artifacts/mixos-install ]; then
            chmod +x artifacts/mixos-install
            artifacts/mixos-install --version || (echo 'installer smoke failed' && exit 1)
          else
            echo "Installer binary not found"; exit 1
          fi

      - name: Autoinstall dry-run
        run: |
          if [ -f artifacts/mixos-install ]; then
            chmod +x artifacts/mixos-install
            artifacts/mixos-install --config packaging/install.yaml --dry-run || (echo 'installer autoinstall dry-run failed' && exit 1)
          else
            echo "Installer binary not found"; exit 1
          fi

      - name: Build packages
        run: |
          mkdir -p artifacts/packages
          for pkg in src/packages/*/build.sh; do
            if [ -f "$pkg" ]; then
              bash "$pkg" || true
            fi
          done

      - name: Build rootfs
        run: |
          chmod +x artifacts/mix
          export BUILD_DIR=/tmp/mixos-build
          export OUTPUT_DIR=${{ github.workspace }}/artifacts
          bash build/scripts/build-rootfs.sh

      - name: Upload rootfs
        uses: actions/upload-artifact@v4
        with:
          name: rootfs
          path: /tmp/mixos-build/rootfs/

  # ============================================================================
  # Build Initramfs (VISO/VRAM support)
  # ============================================================================
  build-initramfs:
    name: Build Initramfs (VISO/VRAM)
    runs-on: ubuntu-latest
    needs: build-rootfs
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cpio gzip xz-utils

      - name: Download rootfs
        uses: actions/download-artifact@v4
        with:
          name: rootfs
          path: /tmp/mixos-build/rootfs/

      - name: Build initramfs
        run: |
          mkdir -p artifacts/boot
          export BUILD_DIR=/tmp/mixos-build
          export OUTPUT_DIR=${{ github.workspace }}/artifacts
          bash build/scripts/build-initramfs.sh

      - name: Upload initramfs
        uses: actions/upload-artifact@v4
        with:
          name: initramfs
          path: artifacts/boot/initramfs-mixos.img

  # ============================================================================
  # Build VISO
  # ============================================================================
  build-viso:
    name: Build VISO Image
    runs-on: ubuntu-latest
    needs: [build-rootfs, build-initramfs, build-kernel]
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            squashfs-tools \
            qemu-utils \
            grub-pc-bin \
            grub-efi-amd64-bin \
            xorriso \
            mtools

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloads/

      - name: Prepare build
        run: |
          mkdir -p /tmp/mixos-build artifacts/boot
          cp -r downloads/rootfs/* /tmp/mixos-build/rootfs/ 2>/dev/null || true
          cp downloads/initramfs/* artifacts/boot/ 2>/dev/null || true
          cp downloads/kernel/* artifacts/ 2>/dev/null || true
          cp downloads/kernel/* artifacts/boot/ 2>/dev/null || true

      - name: Build VISO
        run: |
          export BUILD_DIR=/tmp/mixos-build
          export OUTPUT_DIR=${{ github.workspace }}/artifacts
          export VERSION=${{ env.VERSION }}
          bash build/scripts/build-viso.sh

      - name: Upload VISO
        uses: actions/upload-artifact@v4
        with:
          name: viso
          path: |
            artifacts/*.viso
            artifacts/*.viso.tar.gz
            artifacts/*.vram.tar.gz

  # ============================================================================
  # Build ISO
  # ============================================================================
  build-iso:
    name: Build ISO Image
    runs-on: ubuntu-latest
    needs: [build-rootfs, build-initramfs, build-kernel]
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            squashfs-tools \
            grub-pc-bin \
            grub-efi-amd64-bin \
            xorriso \
            mtools \
            genisoimage

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloads/

      - name: Prepare build
        run: |
          mkdir -p /tmp/mixos-build artifacts/boot
          cp -r downloads/rootfs/* /tmp/mixos-build/rootfs/ 2>/dev/null || true
          cp downloads/initramfs/* artifacts/boot/ 2>/dev/null || true
          cp downloads/kernel/* artifacts/ 2>/dev/null || true
          cp downloads/kernel/* artifacts/boot/ 2>/dev/null || true

      - name: Build ISO
        run: |
          export BUILD_DIR=/tmp/mixos-build
          export OUTPUT_DIR=${{ github.workspace }}/artifacts
          export VERSION=${{ env.VERSION }}
          bash build/scripts/build-iso.sh

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: iso
          path: |
            artifacts/*.iso
            artifacts/*.iso.sha256
            artifacts/*.iso.md5

  # ============================================================================
  # Run Tests
  # ============================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [build-viso, build-iso]
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          merge-multiple: true

      - name: Run VISO tests
        run: |
          export OUTPUT_DIR=${{ github.workspace }}/artifacts
          bash tests/test-viso.sh

  # ============================================================================
  # Release
  # ============================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release/
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: MixOS-GO ${{ github.ref_name }}
          body: |
            ## MixOS-GO ${{ github.ref_name }} ðŸ§¡
            
            ### ðŸš€ Revolutionary Features
            - **VISO**: Virtual ISO format (replaces CDROM)
            - **SDISK**: Selection Disk boot mechanism
            - **VRAM**: Boot entire system from RAM
            - **mixmagisk**: Custom root management (replaces sudo)
            
            ### Downloads
            | File | Description |
            |------|-------------|
            | `mixos-go-*.viso` | VISO image (recommended for QEMU/KVM) |
            | `mixos-go-*.iso` | Traditional ISO image |
            | `mixos-go-*.vram.tar.gz` | VRAM-optimized package |
            
            ### Quick Start
            ```bash
            # VISO boot (maximum performance)
            qemu-system-x86_64 \
              -drive file=mixos-go-v${{ env.VERSION }}.viso,format=qcow2,if=virtio \
              -m 2G -enable-kvm
            
            # VRAM mode (requires 4GB+ RAM)
            qemu-system-x86_64 \
              -drive file=mixos-go-v${{ env.VERSION }}.viso,format=qcow2,if=virtio \
              -m 4G -append "VRAM=auto"
            ```
            
            ### Boot Flow
            1. Boot from VISO/ISO â†’ MixOS Installer
            2. Configure: credentials, network, disk/VRAM, profiles
            3. Reboot with configured parameters
            4. Welcome to MixOS! ðŸ§¡
          files: |
            release/*.viso
            release/*.iso
            release/*.tar.gz
            release/*.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
